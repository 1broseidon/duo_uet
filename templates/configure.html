<section class="section config-page">
    <div class="container">
        <div class="is-flex is-flex-direction-column is-flex-direction-row-tablet is-justify-content-space-between is-align-items-flex-start is-align-items-center-tablet mb-5">
            <div class="mb-4 mb-0-tablet">
                <h1 class="title is-3 mb-2">Tenant Configuration</h1>
                <p class="subtitle is-6 has-text-grey mb-0">Manage your Duo tenants. Admin API credentials are stored per tenant and reused when creating applications from the Home page.</p>
            </div>
            <div class="buttons">
                <button type="button" class="button is-success" id="add-tenant-btn">
                    <span class="icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z"/>
                        </svg>
                    </span>
                    <span>Add New Tenant</span>
                </button>
                <a href="/" class="button">Back to Home</a>
            </div>
        </div>

        <div id="alert-container" class="mb-4"></div>

        {{if .Tenants}}
            {{range .Tenants}}
            <div class="box mb-4" data-tenant-id="{{.Tenant.ID}}">
                <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
                    <div>
                        <h2 class="title is-5 mb-1">{{.Tenant.Name}}</h2>
                        <p class="subtitle is-6 has-text-grey mb-0">{{.Tenant.APIHostname}}</p>
                    </div>
                    <div>
                        <button type="button" class="button is-small is-danger is-outlined delete-tenant-btn" data-tenant-id="{{.Tenant.ID}}" data-tenant-name="{{.Tenant.Name}}">
                            <span class="icon is-small">
                                <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" fill="currentColor" viewBox="0 0 16 16">
                                    <path d="M5.5 5.5A.5.5 0 0 1 6 6v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm2.5 0a.5.5 0 0 1 .5.5v6a.5.5 0 0 1-1 0V6a.5.5 0 0 1 .5-.5zm3 .5a.5.5 0 0 0-1 0v6a.5.5 0 0 0 1 0V6z"/>
                                    <path fill-rule="evenodd" d="M14.5 3a1 1 0 0 1-1 1H13v9a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V4h-.5a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1H6a1 1 0 0 1 1-1h2a1 1 0 0 1 1 1h3.5a1 1 0 0 1 1 1v1zM4.118 4 4 4.059V13a1 1 0 0 0 1 1h6a1 1 0 0 0 1-1V4.059L11.882 4H4.118zM2.5 3V2h11v1h-11z"/>
                                </svg>
                            </span>
                            <span>Delete Tenant</span>
                        </button>
                    </div>
                </div>

                {{if .Applications}}
                <div class="table-container">
                    <table class="table is-hoverable is-fullwidth">
                        <thead>
                            <tr>
                                <th>Application Name</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th class="has-text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Applications}}
                            <tr data-app-id="{{.ID}}">
                                <td class="has-text-weight-semibold" data-label="Name">{{.Name}}</td>
                                <td data-label="Type">
                                    {{$type := .GetApplicationType}}
                                    <span class="tag {{if eq $type "dmp"}}is-info{{else if eq $type "saml"}}is-warning{{else if eq $type "oidc"}}is-link{{else}}is-primary{{end}}">
                                        {{if eq $type "dmp"}}DMP{{else if eq $type "saml"}}SAML{{else if eq $type "oidc"}}OIDC{{else}}WebSDK{{end}}
                                    </span>
                                </td>
                                <td data-label="Status">
                                    {{if .Enabled}}
                                    <span class="tag is-success">Enabled</span>
                                    {{else}}
                                    <span class="tag">Disabled</span>
                                    {{end}}
                                </td>
                                <td data-label="Actions">
                                    <div class="buttons is-justify-content-flex-end">
                                        <button type="button" class="button is-small is-primary is-outlined edit-btn" data-id="{{.ID}}">Edit</button>
                                        <button type="button" class="button is-small is-danger is-outlined delete-btn" data-id="{{.ID}}">Delete</button>
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="notification is-light">
                    <p class="has-text-centered">No applications for this tenant yet. <a href="/">Go to Home</a> to add applications.</p>
                </div>
                {{end}}
            </div>
            {{end}}
        {{else}}
        <div class="box has-text-centered py-6">
            <span class="icon is-large has-text-grey-light mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
            </span>
            <div>
                <h3 class="title is-5 mb-2">No tenants configured</h3>
                <p class="subtitle is-6 has-text-grey mb-4">Add your first Duo tenant. Once added, you can create applications from the Home page.</p>
                <button type="button" class="button is-success" onclick="document.getElementById('add-tenant-btn').click()">Add Tenant</button>
            </div>
        </div>
        {{end}}
    </div>
</section>

<!-- Add Tenant Modal -->
<div class="modal" id="tenantModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add New Tenant</p>
            <button class="delete" aria-label="close" id="tenant-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="notification is-info is-light mb-4">
                <p class="is-size-7">
                    <strong>Tenant:</strong> A tenant stores your Duo Admin API credentials once, and you can create multiple applications under it.
                    Admin API credentials are validated before saving.
                </p>
            </div>
            <form id="tenant-form">
                <div class="field">
                    <label class="label" for="tenant-name">Tenant Name *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-name" name="name" required placeholder="e.g., Production, Staging, Test">
                    </div>
                    <p class="help">A friendly name to identify this tenant (e.g., Production, Staging)</p>
                </div>

                <div class="field">
                    <label class="label" for="tenant-admin-api-key">Admin API Integration Key *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-admin-api-key" name="admin_api_key" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="tenant-admin-api-secret">Admin API Secret Key *</label>
                    <div class="control">
                        <input class="input" type="password" id="tenant-admin-api-secret" name="admin_api_secret" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="tenant-api-hostname">API Hostname *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-api-hostname" name="api_hostname" required placeholder="api-xxxxxxxx.duosecurity.com">
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="tenant-modal-cancel-btn">Cancel</button>
            <button type="submit" class="button is-success" id="tenant-submit-btn" form="tenant-form">Save Tenant</button>
        </footer>
    </div>
</div>

<!-- Edit Application Modal -->
<div class="modal" id="editAppModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Edit Application</p>
            <button class="delete" aria-label="close" id="edit-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <form id="edit-app-form">
                <input type="hidden" id="edit-app-id" name="id">
                <input type="hidden" id="edit-app-tenant-id" name="tenant_id">
                
                <div class="field">
                    <label class="label" for="edit-app-name">Application Name *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-name" name="name" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-client-id">Client ID *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-client-id" name="client_id" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-client-secret">Client Secret *</label>
                    <div class="control">
                        <input class="input" type="password" id="edit-app-client-secret" name="client_secret" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-api-hostname">API Hostname *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-api-hostname" name="api_hostname" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Application Type *</label>
                    <div class="control">
                        <label class="radio">
                            <input type="radio" id="edit-app-type-websdk" name="type" value="websdk" checked>
                            WebSDK (Universal Prompt)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-dmp" name="type" value="dmp">
                            DMP (Device Management Portal)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-saml" name="type" value="saml">
                            SAML 2.0 (Single Sign-On)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-oidc" name="type" value="oidc">
                            OIDC (OpenID Connect)
                        </label>
                    </div>
                    <p class="help">Cannot be changed after creation for SAML/OIDC applications</p>
                </div>

                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="edit-app-enabled" name="enabled">
                            Enabled
                        </label>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="edit-modal-cancel-btn">Cancel</button>
            <button type="submit" class="button is-success" id="edit-submit-btn" form="edit-app-form">Update Application</button>
        </footer>
    </div>
</div>

<script>
const tenantModalElement = document.getElementById('tenantModal');
const editAppModalElement = document.getElementById('editAppModal');
const tenantForm = document.getElementById('tenant-form');
const editAppForm = document.getElementById('edit-app-form');
const alertContainer = document.getElementById('alert-container');

function showAlert(message, type = 'success') {
    const typeClass = type === 'success' ? 'is-success' : 'is-danger';
    alertContainer.innerHTML = `
        <div class="notification ${typeClass} is-light">
            <button class="delete"></button>
            ${message}
        </div>
    `;
    const deleteBtn = alertContainer.querySelector('.delete');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            alertContainer.innerHTML = '';
        });
    }
}

function openTenantModal() {
    tenantForm.reset();
    tenantModalElement.classList.add('is-active');
    document.getElementById('tenant-name').focus();
}

function closeTenantModal() {
    tenantModalElement.classList.remove('is-active');
    tenantForm.reset();
}

function openEditModal(appData) {
    document.getElementById('edit-app-id').value = appData.id;
    document.getElementById('edit-app-tenant-id').value = appData.tenant_id || '';
    document.getElementById('edit-app-name').value = appData.name;
    document.getElementById('edit-app-client-id').value = appData.client_id;
    document.getElementById('edit-app-client-secret').value = appData.client_secret;
    document.getElementById('edit-app-api-hostname').value = appData.api_hostname;
    
    // Set application type radio button
    const appType = appData.type || (appData.is_dmp ? 'dmp' : 'websdk');
    if (appType === 'websdk') {
        document.getElementById('edit-app-type-websdk').checked = true;
    } else if (appType === 'dmp') {
        document.getElementById('edit-app-type-dmp').checked = true;
    } else if (appType === 'saml') {
        document.getElementById('edit-app-type-saml').checked = true;
    } else if (appType === 'oidc') {
        document.getElementById('edit-app-type-oidc').checked = true;
    }
    
    document.getElementById('edit-app-enabled').checked = !!appData.enabled;
    editAppModalElement.classList.add('is-active');
}

function closeEditModal() {
    editAppModalElement.classList.remove('is-active');
    editAppForm.reset();
}

// Event Listeners
document.getElementById('add-tenant-btn').addEventListener('click', openTenantModal);
document.getElementById('tenant-modal-close-btn').addEventListener('click', closeTenantModal);
document.getElementById('tenant-modal-cancel-btn').addEventListener('click', closeTenantModal);
document.getElementById('edit-modal-close-btn').addEventListener('click', closeEditModal);
document.getElementById('edit-modal-cancel-btn').addEventListener('click', closeEditModal);

// Close modals when clicking background
document.querySelectorAll('.modal-background').forEach(bg => {
    bg.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-background')) {
            closeTenantModal();
            closeEditModal();
        }
    });
});

// Tenant Form Submission
tenantForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const submitBtn = document.getElementById('tenant-submit-btn');
    submitBtn.classList.add('is-loading');
    submitBtn.disabled = true;

    const formData = {
        name: document.getElementById('tenant-name').value,
        admin_api_key: document.getElementById('tenant-admin-api-key').value,
        admin_api_secret: document.getElementById('tenant-admin-api-secret').value,
        api_hostname: document.getElementById('tenant-api-hostname').value,
    };

    try {
        const response = await fetch('/api/config/tenants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message || 'Tenant added successfully', 'success');
            closeTenantModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to add tenant', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        submitBtn.classList.remove('is-loading');
        submitBtn.disabled = false;
    }
});

// Edit App Form Submission
editAppForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const appId = document.getElementById('edit-app-id').value;
    const submitBtn = document.getElementById('edit-submit-btn');
    submitBtn.classList.add('is-loading');
    submitBtn.disabled = true;

    // Get selected type
    let selectedType = 'websdk';
    if (document.getElementById('edit-app-type-dmp').checked) {
        selectedType = 'dmp';
    } else if (document.getElementById('edit-app-type-saml').checked) {
        selectedType = 'saml';
    } else if (document.getElementById('edit-app-type-oidc').checked) {
        selectedType = 'oidc';
    }
    
    const formData = {
        tenant_id: document.getElementById('edit-app-tenant-id').value,
        name: document.getElementById('edit-app-name').value,
        type: selectedType,
        enabled: document.getElementById('edit-app-enabled').checked,
        client_id: document.getElementById('edit-app-client-id').value,
        client_secret: document.getElementById('edit-app-client-secret').value,
        api_hostname: document.getElementById('edit-app-api-hostname').value,
    };

    try {
        const response = await fetch(`/api/config/applications/${appId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message || 'Application updated successfully', 'success');
            closeEditModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to update application', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        submitBtn.classList.remove('is-loading');
        submitBtn.disabled = false;
    }
});

// Edit button handler
document.addEventListener('click', async (event) => {
    if (event.target.classList.contains('edit-btn')) {
        const appId = event.target.dataset.id;

        try {
            const response = await fetch('/api/config/applications');
            const data = await response.json();
            const app = data.applications.find((item) => item.id === appId);

            if (app) {
                openEditModal(app);
            }
        } catch (error) {
            showAlert('Failed to load application data', 'danger');
        }
    }
});

// Delete app button handler
document.addEventListener('click', async (event) => {
    if (event.target.classList.contains('delete-btn')) {
        if (!confirm('Are you sure you want to delete this application?')) {
            return;
        }

        const appId = event.target.dataset.id;

        try {
            const response = await fetch(`/api/config/applications/${appId}`, { method: 'DELETE' });
            const result = await response.json();

            if (response.ok) {
                showAlert(result.message || 'Application deleted successfully', 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showAlert(result.error || 'Failed to delete application', 'danger');
            }
        } catch (error) {
            showAlert(`An error occurred: ${error.message}`, 'danger');
        }
    }
});

// Delete tenant button handler
document.addEventListener('click', async (event) => {
    if (event.target.classList.contains('delete-tenant-btn')) {
        const tenantName = event.target.dataset.tenantName;
        if (!confirm(`Are you sure you want to delete tenant "${tenantName}"? This will also delete all applications under this tenant.`)) {
            return;
        }

        const tenantId = event.target.dataset.tenantId;

        try {
            const response = await fetch(`/api/config/tenants/${tenantId}`, { method: 'DELETE' });
            const result = await response.json();

            if (response.ok) {
                showAlert(result.message || 'Tenant deleted successfully', 'success');
                setTimeout(() => window.location.reload(), 800);
            } else {
                showAlert(result.error || 'Failed to delete tenant', 'danger');
            }
        } catch (error) {
            showAlert(`An error occurred: ${error.message}`, 'danger');
        }
    }
});
</script>
