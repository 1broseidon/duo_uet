<section class="section config-page">
    <div class="container">
        <div class="is-flex is-flex-direction-column is-flex-direction-row-tablet is-justify-content-space-between is-align-items-flex-start is-align-items-center-tablet mb-5">
            <div class="mb-4 mb-0-tablet">
                <h1 class="title is-3 mb-2">Tenant Configuration</h1>
                <p class="subtitle is-6 has-text-grey mb-0">Manage your Duo tenants. Admin API credentials are stored per tenant and reused when creating applications from the Home page.</p>
            </div>
            <div class="buttons">
                <button type="button" class="button is-success" id="add-tenant-btn">
                    Add New Tenant
                </button>
                <a href="/" class="button">Back to Home</a>
            </div>
        </div>

        <div id="alert-container" class="mb-4"></div>

        {{if .Tenants}}
            {{range .Tenants}}
            <div class="box mb-4" data-tenant-id="{{.Tenant.ID}}">
                <div class="is-flex is-justify-content-space-between is-align-items-center mb-4">
                    <div>
                        <h2 class="title is-5 mb-1">{{.Tenant.Name}}</h2>
                        <p class="subtitle is-6 has-text-grey mb-0">{{.Tenant.APIHostname}}</p>
                    </div>
                    <div>
                        <button type="button" class="button-action is-danger delete-tenant-btn" data-tenant-id="{{.Tenant.ID}}" data-tenant-name="{{.Tenant.Name}}">
                            Delete Tenant
                        </button>
                    </div>
                </div>

                {{if .Applications}}
                <div class="apps-table-container">
                    <table class="apps-table">
                        <thead>
                            <tr>
                                <th class="col-name">Application Name</th>
                                <th class="col-type">Type</th>
                                <th class="col-status">Status</th>
                                <th class="col-actions">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            {{range .Applications}}
                            <tr class="app-row" data-app-id="{{.ID}}">
                                <td class="app-name" data-label="Name">{{.Name}}</td>
                                <td data-label="Type">
                                    {{$type := .GetApplicationType}}
                                    <span class="tag app-type-tag">
                                        {{if eq $type "dmp"}}DMP{{else if eq $type "saml"}}SAML{{else if eq $type "oidc"}}OIDC{{else}}SDK{{end}}
                                    </span>
                                </td>
                                <td data-label="Status">
                                    {{if .Enabled}}
                                    <span class="tag status-enabled">Enabled</span>
                                    {{else}}
                                    <span class="tag status-disabled">Disabled</span>
                                    {{end}}
                                </td>
                                <td class="app-actions" data-label="Actions">
                                    <div class="is-flex is-justify-content-flex-end mb-0">
                                        <div class="action-group">
                                            <button type="button" class="button-action is-primary is-icon-only edit-btn" data-id="{{.ID}}" title="Edit">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="m16.862 4.487 1.687-1.688a1.875 1.875 0 1 1 2.652 2.652L10.582 16.07a4.5 4.5 0 0 1-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 0 1 1.13-1.897l8.932-8.931Zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0 1 15.75 21H5.25A2.25 2.25 0 0 1 3 18.75V8.25A2.25 2.25 0 0 1 5.25 6H10" />
                                                </svg>
                                            </button>
                                            <button type="button" class="button-action is-danger is-icon-only delete-btn" data-id="{{.ID}}" title="Delete">
                                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                                                    <path stroke-linecap="round" stroke-linejoin="round" d="m14.74 9-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 0 1-2.244 2.077H8.084a2.25 2.25 0 0 1-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 0 0-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 0 1 3.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 0 0-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 0 0-7.5 0" />
                                                </svg>
                                            </button>
                                        </div>
                                    </div>
                                </td>
                            </tr>
                            {{end}}
                        </tbody>
                    </table>
                </div>
                {{else}}
                <div class="notification is-light">
                    <p class="has-text-centered">No applications for this tenant yet. <a href="/">Go to Home</a> to add applications.</p>
                </div>
                {{end}}
            </div>
            {{end}}
        {{else}}
        <div class="box has-text-centered py-6">
            <span class="icon is-large has-text-grey-light mb-4">
                <svg xmlns="http://www.w3.org/2000/svg" width="72" height="72" fill="currentColor" viewBox="0 0 16 16">
                    <path d="M8 1a2 2 0 0 1 2 2v4H6V3a2 2 0 0 1 2-2zm3 6V3a3 3 0 0 0-6 0v4a2 2 0 0 0-2 2v5a2 2 0 0 0 2 2h6a2 2 0 0 0 2-2V9a2 2 0 0 0-2-2z"/>
                </svg>
            </span>
            <div>
                <h3 class="title is-5 mb-2">No tenants configured</h3>
                <p class="subtitle is-6 has-text-grey mb-4">Add your first Duo tenant. Once added, you can create applications from the Home page.</p>
                <button type="button" class="button is-success" onclick="document.getElementById('add-tenant-btn').click()">Add Tenant</button>
            </div>
        </div>
        {{end}}
    </div>
</section>

<!-- Add Tenant Modal -->
<div class="modal" id="tenantModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Add New Tenant</p>
            <button class="delete" aria-label="close" id="tenant-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="notification is-info is-light mb-4">
                <p class="is-size-7">
                    <strong>Tenant:</strong> A tenant stores your Duo Admin API credentials once, and you can create multiple applications under it.
                    Admin API credentials are validated before saving.
                </p>
            </div>
            <form id="tenant-form">
                <div class="field">
                    <label class="label" for="tenant-name">Tenant Name *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-name" name="name" required placeholder="e.g., Production, Staging, Test">
                    </div>
                    <p class="help">A friendly name to identify this tenant (e.g., Production, Staging)</p>
                </div>

                <div class="field">
                    <label class="label" for="tenant-admin-api-key">Admin API Integration Key *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-admin-api-key" name="admin_api_key" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="tenant-admin-api-secret">Admin API Secret Key *</label>
                    <div class="control">
                        <input class="input" type="password" id="tenant-admin-api-secret" name="admin_api_secret" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="tenant-api-hostname">API Hostname *</label>
                    <div class="control">
                        <input class="input" type="text" id="tenant-api-hostname" name="api_hostname" required placeholder="api-xxxxxxxx.duosecurity.com">
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="tenant-modal-cancel-btn">Cancel</button>
            <button type="submit" class="button is-success" id="tenant-submit-btn" form="tenant-form">Save Tenant</button>
        </footer>
    </div>
</div>

<!-- Edit Application Modal -->
<div class="modal" id="editAppModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Edit Application</p>
            <button class="delete" aria-label="close" id="edit-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <form id="edit-app-form">
                <input type="hidden" id="edit-app-id" name="id">
                <input type="hidden" id="edit-app-tenant-id" name="tenant_id">
                
                <div class="field">
                    <label class="label" for="edit-app-name">Application Name *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-name" name="name" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-client-id">Client ID *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-client-id" name="client_id" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-client-secret">Client Secret *</label>
                    <div class="control">
                        <input class="input" type="password" id="edit-app-client-secret" name="client_secret" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label" for="edit-app-api-hostname">API Hostname *</label>
                    <div class="control">
                        <input class="input" type="text" id="edit-app-api-hostname" name="api_hostname" required>
                    </div>
                </div>

                <div class="field">
                    <label class="label">Application Type *</label>
                    <div class="control">
                        <label class="radio">
                            <input type="radio" id="edit-app-type-websdk" name="type" value="websdk" checked>
                            WebSDK (Universal Prompt)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-dmp" name="type" value="dmp">
                            DMP (Device Management Portal)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-saml" name="type" value="saml">
                            SAML 2.0 (Single Sign-On)
                        </label>
                        <label class="radio ml-4">
                            <input type="radio" id="edit-app-type-oidc" name="type" value="oidc">
                            OIDC (OpenID Connect)
                        </label>
                    </div>
                    <p class="help">Cannot be changed after creation for SAML/OIDC applications</p>
                </div>

                <div class="field">
                    <div class="control">
                        <label class="checkbox">
                            <input type="checkbox" id="edit-app-enabled" name="enabled">
                            Enabled
                        </label>
                    </div>
                </div>
            </form>
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="edit-modal-cancel-btn">Cancel</button>
            <button type="submit" class="button is-success" id="edit-submit-btn" form="edit-app-form">Update Application</button>
        </footer>
    </div>
</div>

<!-- Delete Application Confirmation Modal -->
<div class="modal" id="deleteAppModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Delete Application</p>
            <button class="delete" aria-label="close" id="delete-app-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="notification is-danger is-light mb-4">
                <p class="has-text-weight-semibold mb-2">Warning: This action cannot be undone</p>
                <p class="is-size-7">Deleting this application will permanently remove it from the system.</p>
            </div>
            <p>Are you sure you want to delete the application <strong id="delete-app-name"></strong>?</p>
            <input type="hidden" id="delete-app-id">
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="delete-app-cancel-btn">Cancel</button>
            <button type="button" class="button is-danger" id="delete-app-confirm-btn">Delete Application</button>
        </footer>
    </div>
</div>

<!-- Delete Tenant Confirmation Modal -->
<div class="modal" id="deleteTenantModal">
    <div class="modal-background"></div>
    <div class="modal-card">
        <header class="modal-card-head">
            <p class="modal-card-title">Delete Tenant</p>
            <button class="delete" aria-label="close" id="delete-tenant-modal-close-btn"></button>
        </header>
        <section class="modal-card-body">
            <div class="notification is-danger is-light mb-4">
                <p class="has-text-weight-semibold mb-2">Warning: This action cannot be undone</p>
                <p class="is-size-7">Deleting this tenant will permanently remove it and all associated applications from the system.</p>
            </div>
            <p>Are you sure you want to delete the tenant <strong id="delete-tenant-name-display"></strong>?</p>
            <p class="mt-3 has-text-grey is-size-7">This will also delete all applications under this tenant.</p>
            <input type="hidden" id="delete-tenant-id-hidden">
        </section>
        <footer class="modal-card-foot is-justify-content-flex-end">
            <button type="button" class="button" id="delete-tenant-cancel-btn">Cancel</button>
            <button type="button" class="button is-danger" id="delete-tenant-confirm-btn">Delete Tenant</button>
        </footer>
    </div>
</div>

<script>
const tenantModalElement = document.getElementById('tenantModal');
const editAppModalElement = document.getElementById('editAppModal');
const deleteAppModalElement = document.getElementById('deleteAppModal');
const deleteTenantModalElement = document.getElementById('deleteTenantModal');
const tenantForm = document.getElementById('tenant-form');
const editAppForm = document.getElementById('edit-app-form');
const alertContainer = document.getElementById('alert-container');

function showAlert(message, type = 'success') {
    const typeClass = type === 'success' ? 'is-success' : 'is-danger';
    alertContainer.innerHTML = `
        <div class="notification ${typeClass} is-light">
            <button class="delete"></button>
            ${message}
        </div>
    `;
    const deleteBtn = alertContainer.querySelector('.delete');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            alertContainer.innerHTML = '';
        });
    }
}

function openTenantModal() {
    tenantForm.reset();
    tenantModalElement.classList.add('is-active');
    document.getElementById('tenant-name').focus();
}

function closeTenantModal() {
    tenantModalElement.classList.remove('is-active');
    tenantForm.reset();
}

function openEditModal(appData) {
    document.getElementById('edit-app-id').value = appData.id;
    document.getElementById('edit-app-tenant-id').value = appData.tenant_id || '';
    document.getElementById('edit-app-name').value = appData.name;
    document.getElementById('edit-app-client-id').value = appData.client_id;
    document.getElementById('edit-app-client-secret').value = appData.client_secret;
    document.getElementById('edit-app-api-hostname').value = appData.api_hostname;
    
    // Set application type radio button
    const appType = appData.type || (appData.is_dmp ? 'dmp' : 'websdk');
    if (appType === 'websdk') {
        document.getElementById('edit-app-type-websdk').checked = true;
    } else if (appType === 'dmp') {
        document.getElementById('edit-app-type-dmp').checked = true;
    } else if (appType === 'saml') {
        document.getElementById('edit-app-type-saml').checked = true;
    } else if (appType === 'oidc') {
        document.getElementById('edit-app-type-oidc').checked = true;
    }
    
    document.getElementById('edit-app-enabled').checked = !!appData.enabled;
    editAppModalElement.classList.add('is-active');
}

function closeEditModal() {
    editAppModalElement.classList.remove('is-active');
    editAppForm.reset();
}

function openDeleteAppModal(appId, appName) {
    document.getElementById('delete-app-id').value = appId;
    document.getElementById('delete-app-name').textContent = appName;
    deleteAppModalElement.classList.add('is-active');
}

function closeDeleteAppModal() {
    deleteAppModalElement.classList.remove('is-active');
    document.getElementById('delete-app-id').value = '';
    document.getElementById('delete-app-name').textContent = '';
}

function openDeleteTenantModal(tenantId, tenantName) {
    document.getElementById('delete-tenant-id-hidden').value = tenantId;
    document.getElementById('delete-tenant-name-display').textContent = tenantName;
    deleteTenantModalElement.classList.add('is-active');
}

function closeDeleteTenantModal() {
    deleteTenantModalElement.classList.remove('is-active');
    document.getElementById('delete-tenant-id-hidden').value = '';
    document.getElementById('delete-tenant-name-display').textContent = '';
}

// Event Listeners
document.getElementById('add-tenant-btn').addEventListener('click', openTenantModal);
document.getElementById('tenant-modal-close-btn').addEventListener('click', closeTenantModal);
document.getElementById('tenant-modal-cancel-btn').addEventListener('click', closeTenantModal);
document.getElementById('edit-modal-close-btn').addEventListener('click', closeEditModal);
document.getElementById('edit-modal-cancel-btn').addEventListener('click', closeEditModal);
document.getElementById('delete-app-modal-close-btn').addEventListener('click', closeDeleteAppModal);
document.getElementById('delete-app-cancel-btn').addEventListener('click', closeDeleteAppModal);
document.getElementById('delete-tenant-modal-close-btn').addEventListener('click', closeDeleteTenantModal);
document.getElementById('delete-tenant-cancel-btn').addEventListener('click', closeDeleteTenantModal);

// Close modals when clicking background
document.querySelectorAll('.modal-background').forEach(bg => {
    bg.addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-background')) {
            closeTenantModal();
            closeEditModal();
            closeDeleteAppModal();
            closeDeleteTenantModal();
        }
    });
});

// Tenant Form Submission
tenantForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const submitBtn = document.getElementById('tenant-submit-btn');
    submitBtn.classList.add('is-loading');
    submitBtn.disabled = true;

    const formData = {
        name: document.getElementById('tenant-name').value,
        admin_api_key: document.getElementById('tenant-admin-api-key').value,
        admin_api_secret: document.getElementById('tenant-admin-api-secret').value,
        api_hostname: document.getElementById('tenant-api-hostname').value,
    };

    try {
        const response = await fetch('/api/config/tenants', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message || 'Tenant added successfully', 'success');
            closeTenantModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to add tenant', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        submitBtn.classList.remove('is-loading');
        submitBtn.disabled = false;
    }
});

// Edit App Form Submission
editAppForm.addEventListener('submit', async (event) => {
    event.preventDefault();
    
    const appId = document.getElementById('edit-app-id').value;
    const submitBtn = document.getElementById('edit-submit-btn');
    submitBtn.classList.add('is-loading');
    submitBtn.disabled = true;

    // Get selected type
    let selectedType = 'websdk';
    if (document.getElementById('edit-app-type-dmp').checked) {
        selectedType = 'dmp';
    } else if (document.getElementById('edit-app-type-saml').checked) {
        selectedType = 'saml';
    } else if (document.getElementById('edit-app-type-oidc').checked) {
        selectedType = 'oidc';
    }
    
    const formData = {
        tenant_id: document.getElementById('edit-app-tenant-id').value,
        name: document.getElementById('edit-app-name').value,
        type: selectedType,
        enabled: document.getElementById('edit-app-enabled').checked,
        client_id: document.getElementById('edit-app-client-id').value,
        client_secret: document.getElementById('edit-app-client-secret').value,
        api_hostname: document.getElementById('edit-app-api-hostname').value,
    };

    try {
        const response = await fetch(`/api/config/applications/${appId}`, {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(formData),
        });

        const result = await response.json();

        if (response.ok) {
            showAlert(result.message || 'Application updated successfully', 'success');
            closeEditModal();
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to update application', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        submitBtn.classList.remove('is-loading');
        submitBtn.disabled = false;
    }
});

// Edit button handler
document.addEventListener('click', async (event) => {
    const editBtn = event.target.closest('.edit-btn');
    if (editBtn) {
        const appId = editBtn.dataset.id;

        try {
            const response = await fetch('/api/config/applications');
            const data = await response.json();
            const app = data.applications.find((item) => item.id === appId);

            if (app) {
                openEditModal(app);
            }
        } catch (error) {
            showAlert('Failed to load application data', 'danger');
        }
    }
});

// Delete app button handler - opens modal
document.addEventListener('click', async (event) => {
    const deleteBtn = event.target.closest('.delete-btn');
    if (deleteBtn) {
        const appId = deleteBtn.dataset.id;

        // Get app name from the row
        const row = deleteBtn.closest('tr');
        const appName = row.querySelector('.app-name').textContent.trim();

        openDeleteAppModal(appId, appName);
    }
});

// Delete app confirmation handler
document.getElementById('delete-app-confirm-btn').addEventListener('click', async () => {
    const appId = document.getElementById('delete-app-id').value;
    const confirmBtn = document.getElementById('delete-app-confirm-btn');

    confirmBtn.classList.add('is-loading');
    confirmBtn.disabled = true;

    try {
        const response = await fetch(`/api/config/applications/${appId}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok) {
            closeDeleteAppModal();
            showAlert(result.message || 'Application deleted successfully', 'success');
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to delete application', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        confirmBtn.classList.remove('is-loading');
        confirmBtn.disabled = false;
    }
});

// Delete tenant button handler - opens modal
document.addEventListener('click', async (event) => {
    const deleteTenantBtn = event.target.closest('.delete-tenant-btn');
    if (deleteTenantBtn) {
        const tenantId = deleteTenantBtn.dataset.tenantId;
        const tenantName = deleteTenantBtn.dataset.tenantName;

        openDeleteTenantModal(tenantId, tenantName);
    }
});

// Delete tenant confirmation handler
document.getElementById('delete-tenant-confirm-btn').addEventListener('click', async () => {
    const tenantId = document.getElementById('delete-tenant-id-hidden').value;
    const confirmBtn = document.getElementById('delete-tenant-confirm-btn');

    confirmBtn.classList.add('is-loading');
    confirmBtn.disabled = true;

    try {
        const response = await fetch(`/api/config/tenants/${tenantId}`, { method: 'DELETE' });
        const result = await response.json();

        if (response.ok) {
            closeDeleteTenantModal();
            showAlert(result.message || 'Tenant deleted successfully', 'success');
            setTimeout(() => window.location.reload(), 800);
        } else {
            showAlert(result.error || 'Failed to delete tenant', 'danger');
        }
    } catch (error) {
        showAlert(`An error occurred: ${error.message}`, 'danger');
    } finally {
        confirmBtn.classList.remove('is-loading');
        confirmBtn.disabled = false;
    }
});
</script>
